## IoT 대시보드 데이터 파싱 & 상태 관리 정리

### 1. msw 핸들러 정의
- API호출을 위한 핸들러를 정의해 호출 시 이를 활용한다.
- 전체 기기 조회 `/api/devices`, 단일 기기 조회 `/api/devices/:id`를 생성
- 응답 데이터는 `mockData.json`을 그대로 사용한다.
```
import { http, HttpResponse } from 'msw'
import type { Device } from "@/types/Device";
import mockData from "@/data/mockData.json";
 
let devices: Device[] = mockData.devices as Device[];

export const handlers = [
  http.get('/api/devices', () => {
    return HttpResponse.json(devices)
  }),

  http.get('/api/devices/:id', ({ params }) => {
    const { id } = params
    const device = devices.find((d) => d.id === id)

    if (!device) {
      return HttpResponse.json({ message: 'Not found' }, { status: 404 })
    }

    return HttpResponse.json(device)
  }),
]
```

### 2. Recoil 상태 정의
- 전체기기를 상태에 등록하는 로직과, 단일 기기를 상태에 등록하는 로직 두 가지를 구현했다.
- 상세페이지에서는 단일기기요청을 해야하기 때문(전체기기 요청은 기기가 많아질 경우 딜레이 발생)
```
import { atom, selectorFamily } from 'recoil'
import type { Device } from '@/types/Device'

export const devicesState = atom<Device[]>({
  key: 'devicesState',
  default: [],
})

// 상세페이지 조회
export const deviceByIdState = selectorFamily<Device | undefined, string>({
  key: 'deviceByIdState',
  get:
    (id: string) =>
    ({ get }) => {
      const devices = get(devicesState)
      return devices.find((d) => d.id === id)
    },
})
```

### 3. `Dashboard.tsx` – 전체 디바이스 조회
- API 호출: GET `/api/devices`
  - `useGetDevices` 훅에서 첫 마운트 시 전체 디바이스 목록을 조회한다.
  - Recoil에 전체 디바이스 상태 저장

- Dashboard.tsx에서 전체 디바이스 조회 및 렌더링
  - Dashboard 컴포넌트에서는 Recoil 상태를 읽어서 카드 리스트로 렌더링한다.
  - 조회는 `useRecoilValue`로 처리

### 4. `DeviceDetail.tsx` – 단일 디바이스 조회
- URL 파라미터에서 deviceId 추출
  - React Router의 `useParams`로 상세 페이지의 디바이스 ID를 가져온다.

- Recoil 캐시(devicesState)에서 단일 디바이스 조회 시도
  - `useGetDeviceById` 훅 내부에서 우선 Recoil atom에 이미 데이터가 있는지 확인한다.
  - 캐시가 남아있는 경우
    - device가 존재하면 별도의 API 호출 없이 이 값을 그대로 사용한다.
    - Dashboard에서 이미 `/api/devices`를 통해 상태를 채운 뒤 이동한 시나리오에서 동작.

- 캐시가 없을 경우: 단일 조회 API 호출
 - 새로고침 등으로 인해 devicesState가 비어있는 경우(device가 undefined인 경우) GET `/api/devices/:deviceId`를 호출해 단일 디바이스를 조회한다.

- DeviceDetail.tsx에서 단일 디바이스 조회 및 렌더링
  - 훅에서 반환한 device를 이용해 UI를 구성한다.

## 요약 및 한계
- Dashboard.tsx에서 Recoil 상태저장을 하면 페이지 이동 시 조회 가능하지만, GET `/api/devices/:deviceId`를 호출을 통해 DetailDevice.tsx에서 새로고침 하더라도 데이터가 안보이는 문제 해결
### 문제점
1. 상세페이지에서 새로고침하면 Recoil상태가 해당 기기ID 디바이스만 등록된다.
2. 이 상태에서 다시 뒤로가기를 하면 등록된 기기가 하나밖에 없는 문제
### 이유
- 이는 새로고침 했을때 데이터 유지를 위한 msw활용에 의해 생긴 문제이며, 새로고침 시 전체 기기를 모두 조회하는 로직을 사용해 해당 기기만 필터링 해도 되지만, 추후 기기가 늘어났을 때 비효율적이라 생각하여 단일기기 API 호출을 요청했다.